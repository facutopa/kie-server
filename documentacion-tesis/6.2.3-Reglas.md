# 6.2.3 Reglas

## 6.2.3.1 Arquitectura del Sistema de Reglas

El sistema experto para diagnóstico de porfiria implementa un conjunto de reglas organizadas en categorías médicas específicas, siguiendo un esquema modular que permite mayor flexibilidad y mantenibilidad. La división de reglas por categorías clínicas, basada en los diferentes tipos de síntomas y factores de riesgo, se mantiene durante la instanciación de reglas.

### 6.2.3.1.1 Estructura de Clases de Reglas

Cada categoría de reglas contiene métodos que definen las condiciones a cumplir y las acciones a realizar. Estos métodos reciben una instancia de la clase `Patient` para acceder a sus datos clínicos y respuestas del cuestionario, así como una referencia al objeto `CuadroClinico` que se está generando para el diagnóstico.

La Figura 6.8 ejemplifica la implementación de una regla de puntuación para síntomas cutáneos del sistema de diagnóstico de porfiria.

```java
/*
 * REG-001 - Máculas
 * Categoría: Síntomas Cutáneos
 * Puntuación: +2 puntos
 */
rule "REG-001 - Máculas"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "maculas", answer == "SI")
    then
        double nuevosPuntos = $cuadro.getSintomasCutanea() + 2;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        update($cuadro);
end
```

### 6.2.3.1.2 Categorías de Reglas

El sistema implementa tres categorías principales de reglas:

1. **Reglas de Síntomas Cutáneos (REG-001 a REG-012)**: Evalúan manifestaciones dermatológicas
2. **Reglas de Síntomas Agudos (REG-013 a REG-029)**: Evalúan manifestaciones neurológicas y sistémicas
3. **Reglas de Anamnesis (REG-030 a REG-049)**: Evalúan factores de riesgo y antecedentes

### 6.2.3.1.3 Reglas de Diagnóstico

Las clases del paquete `DiagnosticoTemprano` no solo trabajan con las puntuaciones acumuladas, sino que también instancian diagnósticos permitidos para cada paciente basándose en los umbrales establecidos y las puntuaciones obtenidas.

Cada paquete incluye una clase generadora de reglas y funciones responsables de crear reglas basadas en las condiciones proporcionadas. La Figura 6.9 ilustra el diseño de clases agrupadas por paquete.

## 6.2.3.2 Implementación de Reglas por Categoría

### 6.2.3.2.1 Reglas de Síntomas Cutáneos

Las reglas de síntomas cutáneos evalúan manifestaciones dermatológicas específicas de la porfiria. Cada síntoma tiene asignada una puntuación según su relevancia diagnóstica:

```java
/*
 * REG-010 - Fotosensibilidad
 * Categoría: Síntomas Cutáneos
 * Puntuación: +5 puntos (alta relevancia diagnóstica)
 */
rule "REG-010 - Fotosensibilidad"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "fotosensibilidad", answer == "SI")
    then
        double nuevosPuntos = $cuadro.getSintomasCutanea() + 5;
        $cuadro.setSintomasCutanea(nuevosPuntos);
        update($cuadro);
end
```

### 6.2.3.2.2 Reglas de Síntomas Agudos

Las reglas de síntomas agudos evalúan manifestaciones neurológicas y sistémicas que pueden indicar crisis porfírica:

```java
/*
 * REG-014 - Parestesias
 * Categoría: Síntomas Agudos
 * Puntuación: +5 puntos (alta relevancia diagnóstica)
 */
rule "REG-014 - Parestesias"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "parestesias", answer == "SI")
    then
        double nuevosPuntos = $cuadro.getSintomasAguda() + 5;
        $cuadro.setSintomasAguda(nuevosPuntos);
        update($cuadro);
end
```

### 6.2.3.2.3 Reglas de Anamnesis

Las reglas de anamnesis evalúan factores de riesgo y antecedentes familiares que pueden predisponer a la porfiria:

```java
/*
 * REG-031 - Familiares
 * Categoría: Anamnesis
 * Puntuación: +5 puntos (alta relevancia diagnóstica)
 */
rule "REG-031 - Familiares"
    when
        $patient: Patient()
        $cuadro: CuadroClinico(patientId == $patient.id)
        $response: QuestionnaireResponse(questionId == "familiares", answer == "SI")
    then
        double nuevosPuntos = $cuadro.getAnamnesis() + 5;
        $cuadro.setAnamnesis(nuevosPuntos);
        update($cuadro);
end
```

## 6.2.3.3 Reglas de Diagnóstico y Generación de Órdenes

### 6.2.3.3.1 Reglas de Determinación de Sintomatología

El sistema incluye reglas específicas para determinar el tipo de sintomatología predominante:

```java
/*
 * REG-050 - Determinar Sintomatología Aguda
 * Umbral: ≥ 36 puntos en síntomas agudos
 */
rule "REG-050 - Determinar Sintomatología Aguda"
    when
        $patient: Patient()
        $diagnostico: DiagnosticoTemprano(patientId == $patient.id)
        $cuadro: CuadroClinico(patientId == $patient.id, $cuadro.getSintomasAguda() >= 36)
    then
        $diagnostico.setSintomaCutanea(false);
        $diagnostico.setSintomaAguda(true);
        update($diagnostico);
end
```

### 6.2.3.3.2 Reglas de Generación de Órdenes

El sistema genera automáticamente órdenes de estudios complementarios cuando se detecta sintomatología relevante:

```java
/*
 * REG-052 - Ordenar Estudios
 * Se activa cuando se detecta sintomatología cutánea o aguda
 */
rule "REG-052 - Ordenar Estudios"
    when
        $patient: Patient()
        $diagnostico: DiagnosticoTemprano(patientId == $patient.id, sintomaAguda == true || sintomaCutanea == true)
        not GenerarOrden(patientId == $patient.id)
    then   
        GenerarOrden orden = new GenerarOrden();
        orden.setPatientId($patient.getId());
        orden.setEstudios(true);
        insert(orden);
end
```

## 6.2.3.4 Sistema de Puntuación

### 6.2.3.4.1 Umbrales Diagnósticos

El sistema utiliza umbrales específicos para determinar la presencia de sintomatología:

- **Síntomas Cutáneos**: Umbral ≥ 22 puntos
- **Síntomas Agudos**: Umbral ≥ 36 puntos
- **Anamnesis**: Puntuación acumulativa para factores de riesgo

### 6.2.3.4.2 Escala de Puntuación

Las reglas implementan una escala de puntuación que refleja la relevancia diagnóstica de cada síntoma:

- **+5 puntos**: Síntomas altamente específicos (fotosensibilidad, parestesias, ampollas)
- **+4 puntos**: Síntomas muy relevantes (hipertricosis, trastornos psiquiátricos)
- **+3 puntos**: Síntomas moderadamente relevantes (costras, cefaleas)
- **+2 puntos**: Síntomas de relevancia media (máculas, pruritos)
- **+1 punto**: Síntomas de baja relevancia (nódulos, lesiones oculares)
- **+0.5 puntos**: Factores de riesgo menores (diabetes, HTA)

## 6.2.3.5 Reglas de Medicamentos Contraproducentes

El sistema incluye reglas específicas para informar sobre medicamentos que pueden agravar la porfiria:

```java
/*
 * REG-053 - Informar Medicamentos Contraproducentes
 * Se activa cuando se detecta sintomatología aguda
 */
rule "REG-053 - Informar Medicamentos Contraproducentes"
    when
        $patient: Patient()
        $diagnostico: DiagnosticoTemprano(patientId == $patient.id, sintomaAguda == true)
    then
        InformarWeb informar = new InformarWeb();
        informar.setPatientId($patient.getId());
        informar.setMedicamentos(true);
        insert(informar);
end
```

## 6.2.3.6 Ventajas del Diseño Modular

La implementación modular de reglas ofrece las siguientes ventajas:

1. **Mantenibilidad**: Cada categoría de reglas puede ser modificada independientemente
2. **Escalabilidad**: Nuevas reglas pueden ser agregadas sin afectar las existentes
3. **Trazabilidad**: Cada regla tiene un identificador único (REG-XXX) para seguimiento
4. **Flexibilidad**: Los umbrales y puntuaciones pueden ser ajustados según nuevos conocimientos médicos
5. **Auditabilidad**: El sistema permite rastrear qué reglas se activaron para cada diagnóstico

Este diseño modular facilita la actualización del sistema con nuevos conocimientos médicos y permite la personalización de umbrales según las necesidades específicas de cada centro médico.
